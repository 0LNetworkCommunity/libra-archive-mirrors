# this file is used with the backup cli tool
# > libra ops storage db backup continuously --command-adapter-config </path/to/this/file>

env_vars:
  - key: "REMOTE"
    # the configuration name for your rclone remote
    value: "my-s3-config"
  - key: "BUCKET"
    # the namespace of the bucket
    value: "libra-continuous"
  - key: "SUB_DIR"
    value: "backup"

commands:
  create_backup: |
    # backup handle is the same with input backup name, output to stdout
    echo "$BACKUP_NAME"
  create_for_write: |
    # file handle is the file name under the folder with the name of the backup handle
    FILE_HANDLE="$BACKUP_HANDLE/$FILE_NAME"
    # output file handle to stdout
    echo "$FILE_HANDLE"
    # close stdout
    exec 1>&-
    # route stdin to file handle
    gzip -c | rclone rcat "$REMOTE:$BUCKET/$SUB_DIR/$FILE_HANDLE"
  open_for_read: |
    # route file handle content to stdout
    rclone cat "$REMOTE:$BUCKET/$SUB_DIR/$FILE_HANDLE" | gzip -cd
  save_metadata_line: |
    # save the line to a new file under the metadata folder
    FILE_HANDLE="metadata/$FILE_NAME"
    echo "$FILE_HANDLE"
    exec 1>&-
    gzip -c | rclone rcat "$REMOTE:$BUCKET/$SUB_DIR/$FILE_HANDLE"
  list_metadata_files: |
    # list files under the metadata folder
    (rclone ls "$REMOTE:$BUCKET/$SUB_DIR/metadata/" 2>/dev/null || :) | awk '{print "metadata/" $2}'
  backup_metadata_file: |
    # move metadata file to metadata backup folder
    rclone moveto "$REMOTE:$BUCKET/$SUB_DIR/metadata/$FILE_NAME" "$REMOTE:$BUCKET/$SUB_DIR/metadata_backup/$FILE_NAME"
